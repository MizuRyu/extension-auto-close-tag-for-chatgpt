# テストガイド — ChatGPT Auto Close XML Tag (MV3)拡張

このドキュメントは、Chrome上で chat.openai.com または chatgpt.com を使い、AC-1〜AC-7 の要件と拡張オプションに対して手動で検証する方法を説明します。

## 前提条件
- Google Chrome（最新の安定版）
- このリポジトリをローカルにクローン済み
- 拡張機能を「パッケージ化されていない」状態で読み込み済み

### パッケージ化されていない拡張の読み込み方法
1. `chrome://extensions` を開く
2. 「デベロッパーモード」を有効化
3. 「パッケージ化されていない拡張機能を読み込む」をクリックし、このプロジェクトのフォルダを選択
4. 拡張機能が有効になっていることを確認

## 動作対象範囲
- 対象範囲: ChatGPT の統一コンポーザー（ProseMirrorの contenteditable またはフォールバック textarea）のみ
- マッチURL: `https://chat.openai.com/*`, `https://chatgpt.com/*`
- 追加の権限なし、外部ネットワーク通信なし

## テストマトリクス（AC-1〜AC-7＋オプション）
各シナリオを ChatGPT の入力エリア（コンポーザー）で実施してください。フォールバック textarea が現れる場合は両方のエディタで繰り返してください。現れない場合は contenteditable のみで条件を満たします。Newline / Uppercase は拡張機能のオプションページから切り替えて検証します。

- AC-1 自動補完＋キャレット位置（既定は Newline=ON, Uppercase=ON）
  - 入力: `<div` とタイプし、`>` を押す
  - 期待動作: `</div>` が挿入される。Newline OFF: `>` の直後にキャレット。Newline ON: 開閉タグの間（最初の改行後、空行の先頭）にキャレットが移動する。

- AC-2 セルフクローズは非対象・属性は対応
  - 入力: `<div class="x"` で `>` を押す
  - 期待動作: `</div>` が挿入される（属性ありでも補完）
  - 入力: `<div /` で `>` を押す、あるいは `<div/` で `>` を押す
  - 期待動作: セルフクローズの意図として扱い、クローズタグは挿入されない

- AC-3 タグの重複防止
  - 準備: 既にキャレット直後に `</div>` がある状態にする
  - 入力: `>` をタイプ
  - 期待動作: `>` のみが入力され、`</div>` は重複して挿入されない（Newline が ON の場合でも改行は追加しない）

- AC-4 ペア削除
  - 状態: `... <div>|</div>` （`|`は `>` の直後のキャレット位置）
  - 操作: バックスペースを1回押す
  - 期待動作: `>` と直後の `</div>` が1回の操作で一緒に削除される

- AC-5 IME/ペーストによる非発動
  - IME: 日本語IMEを有効化し、変換中に `>` を入力
  - 期待動作: オートクローズは発動しない
  - ペースト: `>` 文字を貼り付け
  - 期待動作: オートクローズは発動しない

- AC-6 ボイドタグのスキップ
  - 入力: `<br` で `>` をタイプ（`img`、`input` などもテスト）
  - 期待動作: `>` のみが入力され、クローズタグは挿入されない

- AC-7 コンポーザー限定スコープ
  - ページ上の他の入力欄（検索ボックスや無関係なフォーム等）で `>` をタイプ
  - 期待動作: オートクローズは発動しない

## エディタタイプ
- Contenteditable（ProseMirror）: ChatGPT のデフォルトエディタ。主なテスト対象。
- フォールバック textarea: 高度なエディタが動作しない場合に稀に現れる。現れた場合は同様にACテストを繰り返す。現れない場合は contenteditable で十分。

## アンドゥ/リドゥ動作
- オートクローズ後: `Cmd+Z` または `Ctrl+Z` を1回押すと、`>` と挿入された改行（Newline ON時）および `</tag>` が一括で元に戻る
- ペア削除後: `Cmd+Z` または `Ctrl+Z` を1回押すと、削除された `>` と `</tag>` がまとめて復元される

## トラブルシューティング
- `>` を入力しても何も起きない場合:
  - 拡張機能が有効で、対象サイト上で動作しているか確認
  - ChatGPT のコンポーザー（画面下部の入力エリア）で入力しているか確認
  - IME変換中でないことを確認
  - 他の拡張機能が `beforeinput` や `keydown` を横取りしている可能性があるので、一時的に無効化して再試行
- Contenteditableでキャレット位置がずれる場合:
  - ProseMirror のテキストノード分割による MVP の既知の制限。シンプルな行で再試行すれば要件は満たすはず

## 対象外のもの（現時点）
 - セルフクローズ判定の高度な処理
 - ChatGPT以外の入力欄・ドメイン

## テスト対象ファイル
- `manifest.json`: MV3（Manifest V3）、最小限のホストマッチ
- `content.js`: `>` 入力時の `beforeinput` でオートクローズ、Backspace の `keydown` でペア削除、コンポーザー範囲限定

## 要件との対応
- トリガー: `beforeinput` の `insertText` & `data === '>'`、Backspace の `keydown`、IMEは無視
- 検出: 最後の `<` から `^<\s*([\p{L}\p{N}_:-][\p{L}\p{N}_\-.:-]*)([^>]*)$`（Unicode）でタグ名を抽出（属性許可）。末尾に `\/` があればセルフクローズ扱いでスキップ。
- ボイドタグ: `area, base, br, col, embed, hr, img, input, link, meta, param, source, track, wbr`
- 重複防止: 既に直後が `</tag>` の場合はスキップ（Newline も追加しない）
- キャレット: Newline OFF時は `>` 直後、ON時は開閉の間（空行）に移動（デフォルトはON）
- アンドゥ: 各ハンドラごとに1回の操作でまとめて戻る

## オプション（オプションページ）の検証
- chrome://extensions → 当該拡張の「拡張機能のオプション」から切り替え
- Newline: ON で `<p` + `>` → `<p>\n\n</p>` となり、キャレットは空行へ
- Uppercase: ON で `<div class="a"` + `>` → `</DIV>` が補完され、同一テキストノード内なら直前の開きタグ名も大文字化
- 非英語タグ: `<要件 id="x"` + `>` や `<１２３` + `>` でも補完されること

## メンテナ向け注意
- ChatGPT の DOM は変更される可能性あり。コンポーザーが変わった場合は `content.js` のコンポーザー検出ロジックを見直し、必要なら `MutationObserver` の導入も検討すること
